<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>사내 문서 검색 챗봇 (운영 모드)</title>
  <style>
    :root{
      --bg: #f6f7fb; --line: #e6e8ef; --text: #111827; --muted: #6b7280;
      --user-bg: #eaf2ff; --user-line: #cfe0ff; --bot-bg: #ffffff; --bot-line: #e5e7eb;
      --shadow: 0 6px 20px rgba(0,0,0,.06); --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); }
    .app { height: 100%; display: flex; flex-direction: column; }
    header { background: rgba(246,247,251,.92); backdrop-filter: blur(8px); border-bottom: 1px solid var(--line); padding: 16px; position: sticky; top: 0; z-index: 10; }
    .wrap { width: 100%; max-width: 900px; margin: 0 auto; }
    .title { font-size: 20px; font-weight: 800; margin: 0; }
    main { flex: 1; overflow-y: auto; padding: 20px 14px 100px; }
    .chat { display: flex; flex-direction: column; gap: 14px; }
    .row { display: flex; width: 100%; }
    .row.user { justify-content: flex-end; }
    .row.bot { justify-content: flex-start; }
    .msg { display: flex; flex-direction: column; gap: 4px; max-width: 85%; }
    .row.user .msg { align-items: flex-end; }
    .row.bot .msg { align-items: flex-start; }
    .bubble { display: inline-block; width: auto; max-width: 100%; padding: 10px 14px; border-radius: var(--radius); border: 1px solid var(--bot-line); background: var(--bot-bg); white-space: pre-wrap; line-height: 1.5; box-shadow: var(--shadow); word-break: break-all; }
    .row.user .bubble { background: var(--user-bg); border-color: var(--user-line); text-align: right; }
    .meta { font-size: 11px; color: var(--muted); margin-top: 4px; }
    .composer { position: fixed; bottom: 0; width: 100%; background: rgba(246,247,251,.95); backdrop-filter: blur(8px); border-top: 1px solid var(--line); padding: 12px; }
    .bar { display: flex; gap: 10px; max-width: 900px; margin: 0 auto; }
    textarea { flex: 1; height: 48px; border-radius: 12px; border: 1px solid var(--line); padding: 13px; font-size: 16px; resize: none; outline: none; }
    button { background: #111827; color: white; border: none; border-radius: 12px; padding: 0 20px; font-weight: bold; cursor: pointer; }
    button:disabled { opacity: 0.5; }
  </style>
</head>
<body>
  <div class="app">
    <header><div class="wrap"><h1 class="title">사내 문서 검색 챗봇</h1></div></header>
    <main id="main"><div class="wrap"><div class="chat" id="chat"></div></div></main>
    <div class="composer"><div class="wrap"><div class="bar">
      <textarea id="q" placeholder="질문을 입력하세요"></textarea>
      <button id="send">전송</button>
    </div></div></div>
  </div>
  <script>
    // ✅ n8n Cloud Run Webhook URL로 수정 완료
    const WEBHOOK_URL = "https://n8n-431387416914.asia-northeast3.run.app/webhook-test/ask";
    
    const chatEl = document.getElementById("chat");
    const qEl = document.getElementById("q");
    const sendBtn = document.getElementById("send");
    const mainEl = document.getElementById("main");

    function pushMsg(role, text) {
      const row = document.createElement("div");
      row.className = `row ${role}`;
      row.innerHTML = `<div class="msg"><div class="bubble">${text}</div><div class="meta">${role==='user'?'나':'봇'}</div></div>`;
      chatEl.appendChild(row);
      mainEl.scrollTop = mainEl.scrollHeight;
    }

    async function send() {
      const text = qEl.value.trim();
      if (!text) return;
      pushMsg("user", text);
      qEl.value = "";
      sendBtn.disabled = true;
      try {
        const res = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            question: text, 
            userId: "web-user-prod",
            conversationId: "conv-" + Date.now()
          })
        });
        const data = await res.json();
        pushMsg("bot", data.answer || "응답이 없습니다.");
      } catch (e) {
        pushMsg("bot", "에러: " + e.message);
      } finally {
        sendBtn.disabled = false;
        qEl.focus();
      }
    }
    sendBtn.onclick = send;
    qEl.onkeydown = e => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); send(); } };
  </script>
</body>
</html>
